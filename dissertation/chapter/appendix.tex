\startcomponent appendix
\product dissertation

\usemodule[steps]

\setuphead[chapter][textstyle={\tfd\sc}]
\startchapter[title=Appendix: Research Proposal]
\startsection[title=Research Proposal Abstract]
This proposal for a master's dissertation on the "Internet of Things" is looking at a novel way of predicting cyber threats of a specific sub-set of said cyber-physical systems \cite[authoryear][citeulike:13779694], by applying a specialised version of the Bayesian estimation to compare the predicted behaviour of cyber-physical systems with the actual motion patterns \cite[Fox03bayesianfiltering]. Taking advantage of known-good behaviour of large-scale movement flows at a regulated traffic \cite[perallos2015intelligent], it can be deducted when a system behaves in a rogue manner. \par
\stopsection

\startsection[title=Project Timetable]
{\ssx
\startplacefigure[location=place,title={Project Timetable}]
\startxtable[option={width},foregroundstyle={\ss},offset=1mm]
\startxtablehead[foregroundstyle={\ss\bf}]
\startxrow
\startxcell[width=85mm] Project Milestone \stopxcell \startxcell[width=70mm,align=middle] Indicative Timescales \stopxcell
\stopxrow
\stopxtablehead
\startxtablebody
\startxrow
\startxcell Briefing by Project Tutor \stopxcell \startxcell[align=middle] July 2016 \stopxcell
\stopxrow
\startxrow
\startxcell Submission of Project Initiation Form \stopxcell \startxcell[align=middle] July 2016 \stopxcell
\stopxrow
\startxrow
\startxcell Submission of Research Proposal \stopxcell \startxcell[align=middle] 09 July 2016 \stopxcell
\stopxrow
\startxrow
\startxcell Research Proposal Review Meeting \\ Submission of MSc Project Ethical and \\ Risk Assessment Form \stopxcell \startxcell[align=middle] December 2016 \\ 25 November 2016 \stopxcell
\stopxrow
\startxrow
\startxcell Submission of Dissertation \blank[line] Seminar Presentation \stopxcell \startxcell[align=middle] (19 January 2017) \\ 30 March 2017 \\ 01-08 April 2017 \stopxcell
\stopxrow
\startxrow
\startxcell Award Board \stopxcell \startxcell[align=middle] June 2017 \stopxcell
\stopxrow
\stopxtablebody
\stopxtable
\stopplacefigure}
\stopsection

\startsection[title=Project Deadlines]
{\ssx
\startplacefigure[location=place,title={Key Facts and Dates/Deadlines}]
\startxtable[option={width},foregroundstyle={\ss\bf},offset=1mm]
\startxrow
\startxcell[width=85mm] Deadline for submitting Project Initiation Form \stopxcell \startxcell[width=70mm,align=left] 02 July 2016 \stopxcell
\stopxrow
\startxrow
\startxcell[height=7mm] Deadline for submitting Research Proposal \stopxcell \startxcell[align=left] 01 August 2016 \stopxcell
\stopxrow
\startxrow
\startxcell[height=7mm] Date of Research Proposal Review Meeting \stopxcell \startxcell[align=left] 01 August 2016 \stopxcell
\stopxrow
\startxrow
\startxcell[height=12mm] Deadline for submitting MSc Project Ethical and Risk Assessment Form \stopxcell \startxcell[align=left] 01 August 2016 \stopxcell
\stopxrow
\startxrow
\startxcell[height=7mm] Deadline for submitting Dissertation \stopxcell \startxcell[align=left] 19 January 2017 / 30 March 2017 \stopxcell
\stopxrow
\startxrow
\startxcell[height=7mm] Date of Viva \stopxcell \startxcell[align=left] February/April 2017 \stopxcell
\stopxrow
\startxrow
\startxcell[height=7mm] Name of Supervisor \stopxcell \startxcell[align=left] Dr Haider al-Khateeb \stopxcell
\stopxrow
\startxrow
\startxcell[height=7mm] Name of Second Marker \stopxcell \startxcell[align=left] Ahmed Bouridane \stopxcell
\stopxrow
\startxrow
\startxcell[height=7mm] Name of Project Tutor \stopxcell \startxcell[align=left] Dr Ali Mansour \stopxcell
\stopxrow
\startxrow
\startxcell[height=7mm] Name of Programme Leader \stopxcell \startxcell[align=left] Prof Hamid Jahankhani \stopxcell
\stopxrow
\stopxtable
\stopplacefigure}
\stopsection

\startsection[title=Schedule of Activities: Project Plan]
\startplacefigure[location=place,title={ProjectLibre Gantt Chart}]
% Landscape, Legal, 100%
% Landscape, Designated-long, 75%
\externalfigure[project][page=1,width=\textwidth]
\stopplacefigure
\stopsection

\startsection[title=Time Management: Supervisor Meetings]
Regular VoIP meetings every fortnight (Sundays 6pm, 1 hour) \par
\blank[line]
% http://www.texample.net/tikz/examples/changing-the-default-calendar-layout/
\startxtable[option=stretch,align={middle,lohi}]
\startxrow
\startxcell {\it November 2016} \\ \hfil \startframed[frame=on,strut=no,offset=0mm]
\startxtable[frame=off]
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] \stopxcell \startxcell \stopxcell \startxcell 1 \stopxcell \startxcell 2 \stopxcell \startxcell 3 \stopxcell \startxcell 4 \stopxcell \startxcell 5 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue,background=color,backgroundcolor=darkred] 6 \stopxcell \startxcell 7 \stopxcell \startxcell 8 \stopxcell \startxcell 9 \stopxcell \startxcell 10 \stopxcell \startxcell 11 \stopxcell \startxcell 12 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 13 \stopxcell \startxcell[background=color,backgroundcolor=darkred] 14 \stopxcell \startxcell 15 \stopxcell \startxcell 16 \stopxcell \startxcell 17 \stopxcell \startxcell 18 \stopxcell \startxcell 19 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 20 \stopxcell \startxcell 21 \stopxcell \startxcell 22 \stopxcell \startxcell 23 \stopxcell \startxcell 24 \stopxcell \startxcell 25 \stopxcell \startxcell 26 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 27 \stopxcell \startxcell[background=color,backgroundcolor=darkred] 28 \stopxcell \startxcell 29 \stopxcell \startxcell 30 \stopxcell \startxcell \stopxcell \startxcell \stopxcell \startxcell \stopxcell \stopxrow
\stopxtable
\stopframed \hfil \ \\ \stopxcell
\startxcell {\it December 2016} \\ \hfil \startframed[frame=on,strut=no,offset=0mm]
\startxtable[frame=off]
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] \stopxcell \startxcell \stopxcell \startxcell \stopxcell \startxcell \stopxcell \startxcell 1 \stopxcell \startxcell 2 \stopxcell \startxcell 3 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 4 \stopxcell \startxcell 5 \stopxcell \startxcell 6 \stopxcell \startxcell 7 \stopxcell \startxcell 8 \stopxcell \startxcell 9 \stopxcell \startxcell 10 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 11 \stopxcell \startxcell[background=color,backgroundcolor=darkred] 12 \stopxcell \startxcell 13 \stopxcell \startxcell 14 \stopxcell \startxcell 15 \stopxcell \startxcell 16 \stopxcell \startxcell 17 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 18 \stopxcell \startxcell 19 \stopxcell \startxcell 20 \stopxcell \startxcell 21 \stopxcell \startxcell 22 \stopxcell \startxcell 23 \stopxcell \startxcell 24 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 25 \stopxcell \startxcell[background=color,backgroundcolor=darkred] 26 \stopxcell \startxcell 27 \stopxcell \startxcell 28 \stopxcell \startxcell 29 \stopxcell \startxcell 30 \stopxcell \startxcell 31 \stopxcell \stopxrow
\stopxtable
\stopframed \hfil \ \\ \stopxcell
\startxcell {\it January 2017} \\ \hfil \startframed[frame=on,strut=no,offset=0mm]
\startxtable[frame=off]
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 1 \stopxcell \startxcell 2 \stopxcell \startxcell 3 \stopxcell \startxcell 4 \stopxcell \startxcell 5 \stopxcell \startxcell 6 \stopxcell \startxcell 7 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 8 \stopxcell \startxcell[background=color,backgroundcolor=darkred] 9 \stopxcell \startxcell 10 \stopxcell \startxcell 11 \stopxcell \startxcell 12 \stopxcell \startxcell 13 \stopxcell \startxcell 14 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 15 \stopxcell \startxcell 16 \stopxcell \startxcell 17 \stopxcell \startxcell 18 \stopxcell \startxcell 19 \stopxcell \startxcell 20 \stopxcell \startxcell 21 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 22 \stopxcell \startxcell[background=color,backgroundcolor=darkred] 23 \stopxcell \startxcell 24 \stopxcell \startxcell 25 \stopxcell \startxcell 26 \stopxcell \startxcell 27 \stopxcell \startxcell 28 \stopxcell \stopxrow
 \startxrow \startxcell[foreground=color,foregroundcolor=blue] 29 \stopxcell \startxcell 30 \stopxcell \startxcell 31 \stopxcell \startxcell \stopxcell \startxcell \stopxcell \startxcell \stopxcell \startxcell \stopxcell \stopxrow
\stopxtable
\stopframed \hfil \ \\ \stopxcell
\stopxrow
\stopxtable
\stopsection

\startsection[title=Project Start Schedule]
\startitemize[n,joindup,nowhite][stopper={)}]
\item Dissertation coordinator sets up link on BlackBoard and sends a communication to all students to complete and submit ethics approval form.
\item Student fill ethics approval form with the help of supervisor and submits via BlackBoard.
\item Supervisor approves the form if the project is in Green category - no primary data is being collected, no sensitive info, no vulnerable population, etc. Then, supervisor sends the form to Second marker, dissertation coordinator and Programme leader
\item If the project is Amber category, medium risk project, then dissertation coordinator after consultation with supervisor will send form to second marker for approval.
\item If the project is Red category (high risk) as it involves vulnerable group, sensitive data (NHS, etc.), dissertation module coordinator will send the form to ethics committee â€“ I will send details if required. Our aim should be to discourage students to do such projects having high risks in the first place.
\item Programme leader sends all ethics form to Associate Dean (London Campus) for review.
\stopitemize
\stopsection
\stopchapter

\startchapter[title={Appendix: Figures and Diagrams},reference=appendix:figures]
\startsection[title=Pictures]
{
\setupcaptions[prefix=yes,way=bysection,prefixconnector={.P.},location={left}]
\startplacefigure[location=place,reference={figure:tesla},title={Connected Car with \\ Sensors (Tesla Model X)},list={Connected Car with Sensors (Tesla Model X)},style={cap}]
\startframed[frame=off,strut=no,offset=0mm]
\mirror{\externalfigure[tesla-x][height=25mm]}
\stopframed
\stopplacefigure
%\placefigure[left][picture:2]{Picture Model X}{\externalfigure[tesla-x][width=50mm]}
}
\stopsection

\startsection[title={Charts},reference=section:charts]
{
\setupcaptions[prefix=yes,way=bysection,prefixconnector={.C.},location={left}]
\startplacefigure[location=place,reference={chart:rstan},title={RStan Bayesian Estimation: Distribution Graph},style={cap}]
\startframed[frame=off,strut=no,offset=0mm,width=80mm]
\externalfigure[baseline][height=50mm]
\stopframed
\stopplacefigure
%\placefigure[place]{RStan}{\externalfigure[rstan][height=60mm]}

\startplacefigure[location=place,reference={chart:deviation},title={RStan Bayesian Estimation: Filter},style={cap}]
%\processRfile{sample.R}
\startframed[frame=off,strut=no,offset=0mm,width=80mm]
\externalfigure[deviation][height=50mm]
\stopframed
\stopplacefigure

%\startplacefigure[location=place,reference={chart:3},title={Pie Chart}]
%\startframed[frame=off,strut=no,offset=0mm,width=50mm]
%\startMPcode draw fullcircle scaled 3cm; \stopMPcode
%\stopframed
%\stopplacefigure
}
\stopsection

\startsection[title=Tables]
{
\setupcaptions[prefix=yes,way=bysection,prefixconnector={.T.},location={left}]
\startplacetable[location=place,reference={table:ads},title={Automatic \\ Dependent Surveillance: \\ Sample Log},list={Automatic Dependent Surveillance: Sample Log},style={cap}]
\defineseparatedlist[CSV][separator=comma,left=\startxcell,right=\stopxcell,first=\startxrow,last=\stopxrow,before=\startxtablebody,after=\stopxtablebody]
\setupxtable[align=flushright,align=middle]
\startxtable[split=yes,foregroundstyle=\ss,bodyfont=8pt]
\startxtablehead[background=color,backgroundcolor=gray]
\startxrow
 \startxcell[width=25mm] Time \stopxcell
 \startxcell Position \stopxcell
 \startxcell Orientation \stopxcell
 \startxcell Groundspeed \stopxcell
 \startxcell Altitude \stopxcell
 \startxcell Reporting \stopxcell
\stopxrow
\stopxtablehead
% http://i.imgur.com/Pkk38yU.png
% https://pbs.twimg.com/media/CiytDdDU4AII8h_.jpg:large
% Time,Position,Orientation,Groundspeed,Altitude,Reporting
\startCSV
Thu 01:18:41,34.87 27.54,SE 138,520,37000,0
Thu 01:19:11,34.81 27.59,SE 138,520,37000,0
Thu 01:19:41,34.76 27.65,SE 138,520,37000,0
Thu 01:20:11,34.70 27.71,SE 138,519,37000,0
Thu 01:20:41,34.65 27.77,SE 138,521,37000,0
Thu 01:21:50,34.52 27.90,SE 139,521,37000,0
Thu 01:22:49,34.47 27.96,SE 139,528,37000,0
Thu 01:28:10,33.82 28.63,SE 139,527,37000,0
Thu 01:28:46,33.77 28.68,SE 139,529,37000,0
Thu 01:29:21,33.69 28.77,SE 136,533,37000,0
Thu 01:32:01,33.39 29.00,SE 147,0,37000,0
Thu 01:33:01,33.27 29.09,SE 147,0,37000,0
\stopCSV
\stopxtable
\stopplacetable

%\startplacetable[location=place,reference={table:2},title={Table}]
%\startxtable
%\startxrow[width=25mm,align=middle]
%\startxcell 1 \stopxcell
%\startxcell 2 \stopxcell
%\startxcell 3 \stopxcell
%\stopxrow
%\startxrow
%\startxcell \ \stopxcell
%\startxcell \stopxcell
%\startxcell \stopxcell
%\stopxrow
%\stopxtable
%\stopplacetable
}
\stopsection

\startsection[title=Design Diagrams]
{
\setupcaptions[prefix=yes,way=bysection,prefixconnector={.D.},location={left}]
\startplacefigure[location=place,reference={diagram:flowchart},title={Anomality Threshold},style={cap}]
\startframed[frame=off,strut=no,offset=0mm]
\startSTEPchart
\cell {CPS Systems}
\cell {Route 1} \texts{$$+5 \%$$}{$$-5 \%$$}
\cell {Route 2} \texts{$$+5 \%$$}{$$-5 \%$$}
\cell {Route 3} \texts{$$+5 \%$$}{$$-5 \%$$}
\cell {Route 4}
\stopSTEPchart
\stopframed
\stopplacefigure
}
\stopsection
\stopchapter

\startchapter[title={Appendix: Source Code},reference=appendix:code]
\startsection[title={Routes anomality with Bayesian filtering (R Language)}]

\setuptyping[option=color]
\setuplinenumbering[location=text]
\defineframedtext[framedcode][frame=off,strut=yes,offset=2mm,width=\textwidth,align=right]
\definetyping[code][numbering=line,bodyfont=small,before={\startframedcode},after={\stopframedcode}]

%\hairline
\framedtext[leftframe=off,rightframe=off,width=max,offset=0mm,align=middle]{\ss cars_bayesian.stan}
%\hairline
\startcode
library(extrafont)
library(rstan)
library(coda)
set.seed(20170102)

dat<-data.frame(x1=runif(100,-2,2),x2=runif(100,-2,2))
X<-model.matrix(~x1*x2,dat)
betas<-runif(4,-1,1)
sigma<-1
y_norm<-rnorm(100,X%*%betas,sigma)
new_X<-model.matrix(~x1*x2,expand.grid(x1=seq(min(dat$x1),
max(dat$x1),length=20),x2=c(min(dat$x2),mean(dat$x2),max(dat$x2))))
setwd("stan")
m_norm<-stan(file="cars_bayesian.stan",data =
list(N=100,N2=60,K=4,y=y_norm,X=X,new_X=new_X),pars =
c("beta","sigma","y_pred"))
apply(extract(m_norm,pars="beta")$beta,2,function(x) length(which(x>0))/4000)

new_x<-data.frame(x1=new_X[,2],x2=rep(c("min","mean","max"),each=20))
new_y<-extract(m_norm,pars="y_pred")
pred<-apply(new_y[[1]],2,quantile,probs=c(0.025,0.5,0.975))

plot(dat$x1,y_norm,pch="+",xlab="Speed",ylab="Geolocation")
lines(new_x$x1[1:20],pred[2,21:40],col="orange",lwd=3)
lines(new_x$x1[1:20],pred[1,21:40],col="orange",lwd=1,lty=2)
lines(new_x$x1[1:20],pred[3,21:40],col="orange",lwd=1,lty=2)
legend("topright",legend=c("Baseline"),lty=1,col=c("orange"),bty = "n",title = "Cyber Anomaly")
\stopcode
\hairline
\stopsection

\page[yes]

\startsection[title={Bayesian Estimation Supersedes the T-Test (PyMC3)}]

\setuptyping[option=color]
\setuplinenumbering[location=text]
\defineframedtext[framedcode][frame=off,strut=yes,offset=2mm,width=\textwidth,align=right]
\definetyping[code][numbering=line,bodyfont=small,before={\startframedcode},after={\stopframedcode}]

%\hairline
\framedtext[leftframe=off,rightframe=off,width=max,offset=0mm,align=middle]{\ss bayesian_supersedes.py}
%\hairline
\startcode
%matplotlib inline
import numpy as np
import pymc3 as pm
import pandas as pd
import seaborn as sns
sns.set(color_codes=True)

np.random.seed(20170329)

known_good = (101,100,102,104,102,97,105,105,98,101,100,123,105,103,100,95,102,
              106,109,102,82,102,100,102,102,101,102,102,103,103,97,97,103,101,
              97,104,96,103,124,101,101,100,101,101,104,100,101)
known_bad  = (99,101,100,101,102,100,97,101,104,101,102,102,100,105,88,101,100,
              104,100,100,100,101,102,103,97,101,101,100,101,99,101,100,100,101,
              100,99,101,100,102,99,100,99)

y1 = np.array(known_good)
y2 = np.array(known_bad)
y  = pd.DataFrame(dict(value=np.r_[y1, y2], group = 
     np.r_[['known_good']*len(known_good), ['known_bad']*len(known_bad)]))

y.hist('value', by='group');
\stopcode
\hairline
\stopsection

\page[yes]

\startsection[title={Optimal Bayesian solution (PyBayes)}]

\setuptyping[option=color]
\setuplinenumbering[location=text]
\defineframedtext[framedcode][frame=off,strut=yes,offset=2mm,width=\textwidth,align=right]
\definetyping[code][numbering=line,bodyfont=small,before={\startframedcode},after={\stopframedcode}]

%\hairline
\framedtext[leftframe=off,rightframe=off,width=max,offset=0mm,align=middle]{\ss bayesian_kalman.py}
%\hairline
\startcode
filter.bayes(yt)
log_likelihood = filter.evidence_log(yt)

# initialise control-less Kalman filter:
kf = pb.KalmanFilter(A=np.array([[1.]]),
C=np.array([[1.]]),
Q=np.array([[0.7]]), R=np.array([[0.3]]),
state_pdf=pb.GaussPdf(...))
\stopcode
\hairline

\blank[line]

%\hairline
\framedtext[leftframe=off,rightframe=off,width=max,offset=0mm,align=middle]{\ss bayesian_filter.py}
%\hairline
\startcode
from copy import copy, deepcopy
import numpy as np
import pybayes as pb
from support import PbTestCase

class TestKalmanFilter(PbTestCase):
  """Kalman filter"""
  def setUp(self):
    # synthetic parameters
    self.setup_1 = {
      "A":np.array([[1, 2], [3, 4]]),
      "B":np.array([[1, 2, 3], [4, 5, 6]]),
      "C":np.array([[1, 2], [3, 4], [5, 6], [7, 8]]),
      "D":np.array([[1, 2, 3], [5, 6, 7], [9, 1, 2], [2, 3, 4]]),
      "Q":np.array([[2, 3], [4, 5]]),
      "R":np.array([[1, 2, 3, 4], [5, 6, 7, 8], [9, 1, 2, 3], [2, 3, 4, 5]]),
      "state_pdf":pb.GaussPdf(np.array([1, 2]), np.array([[1, 0], [0, 2]]))
    }
    self.setup_2 = {
      "A":np.array([[1.0, -0.5],[1.0, 0.0]]),
      "B":np.array([[1.0],[0.1]]),
      "C":np.array([[1.0, 0.0]]),
      "D":np.array([[0.1]]),
      "Q":np.array([[0.2, 0.0],[0.0, 0.2]]),
      "R":np.array([[0.01]]),
      "state_pdf":pb.GaussPdf(np.array([0.0, 0.0]),
        np.array([[200.0, 0.0],[0.0, 200.0]]))
    }

  def test_init(self):
    k = pb.KalmanFilter(**self.setup_1)
    self.assertEqual(type(k), pb.KalmanFilter)
    l = pb.KalmanFilter(**self.setup_2)
    self.assertEqual(type(l), pb.KalmanFilter)
\stopcode
\hairline

\page[yes]

%\hairline
\framedtext[leftframe=off,rightframe=off,width=max,offset=0mm,align=middle]{\ss bayesian_filter.py (continued)}
%\hairline
\startcode[continue]
  def test_invalid_init(self):
    args = ["A", "B", "C", "D", "Q", "R", "state_pdf"]

    # invalid type:
    for arg in args:
      setup = self.setup_1.copy()
      setup[arg] = 125.65
      self.assertRaises(TypeError, pb.KalmanFilter, **setup)

    # invalid dimension
    del args[6]
    for arg in args:
      setup = self.setup_1.copy()
      setup[arg] = np.array([[1],[2]])
      self.assertRaises(ValueError, pb.KalmanFilter, **setup)
    gauss = pb.GaussPdf(np.array([1]), np.array([[1]]))
    setup = self.setup_1.copy()
    setup['state_pdf'] = gauss
    self.assertRaises(ValueError, pb.KalmanFilter, **setup)

  def test_bayes(self):
    k = pb.KalmanFilter(**self.setup_2)
    y = np.array([[4.1], [-0.2], [1.4], [-2.1]])
    u = np.array([[4.8], [-0.3], [1.1], [-1.8]])
    exp_mu = np.array([
      [ 3.62004716, -0.46320771],
      [-0.16638519,  3.58787721],
      [ 1.21108425,  0.0224309 ],
      [-1.87141692,  0.98517451]
    ])
    for i in range(4):
      k.bayes(y[i], u[i])
      mu = k.posterior().mu
      self.assertApproxEqual(mu, exp_mu[i])
  def test_copy(self):
    """Copying KF to check if it works as expected"""
    o = pb.KalmanFilter(**self.setup_1)
    c = copy(o)
    self.assertEqual(type(c), type(o))

    self.assertTrue(id(o) != id(c))
    self.assertTrue(id(o.A) == id(c.A))
    self.assertTrue(id(o.B) == id(c.B))
    self.assertTrue(id(o.C) == id(c.C))
    self.assertTrue(id(o.D) == id(c.D))
    self.assertTrue(id(o.Q) == id(c.Q))
    self.assertTrue(id(o.R) == id(c.R))
    self.assertTrue(id(o.n) == id(c.n))
    self.assertTrue(id(o.k) == id(c.k))
    self.assertTrue(id(o.j) == id(c.j))
    self.assertTrue(id(o.P) == id(c.P))
    self.assertTrue(id(o.S) == id(c.S))
\stopcode
\hairline

\page[yes]

%\hairline
\framedtext[leftframe=off,rightframe=off,width=max,offset=0mm,align=middle]{\ss bayesian_filter.py (continued)}
%\hairline
\startcode[continue]
  def test_deepcopy(self):
    """Deep copying KF to check if it works as expected"""
    o = pb.KalmanFilter(**self.setup_2)
    c = deepcopy(o)
    self.assertEqual(type(c), type(o))

    self.assertTrue(id(o) != id(c))
    for (a, b) in
      [(o.A, c.A), (o.B, c.B), (o.C, c.C), (o.D, c.D), (o.Q, c.Q),(o.R, c.R)]:
      self.assertArraysEqualNotSame(a, b)
    # n, k, j do not need to be different as they are immutable
    self.assertEqual(o.n, c.n)
    self.assertEqual(o.k, c.k)
    self.assertEqual(o.j, c.j)
    self.assertTrue(id(o.P) != id(c.P))
    self.assertArraysEqualNotSame(o.P.mu, c.P.mu)
    self.assertArraysEqualNotSame(o.P.R, c.P.R)
    self.assertTrue(id(o.S) != id(c.S))

class testParticleFilter(PbTestCase):
  """Particle filter"""
  def setUp(self):
    init_pdf = pb.UniPdf(np.array([-5.]), np.array([5.]))
    p_xt_xtp = pb.MLinGaussCPdf(np.array([[2.]]), np.array([[1.]]),
      np.array([0.]))
    p_yt_xt = pb.MLinGaussCPdf(np.array([[1.]]), np.array([[1.]]),
      np.array([0.]))

    self.pf = pb.ParticleFilter(20, init_pdf, p_xt_xtp, p_yt_xt)

  def test_init(self):
    self.assertEqual(type(self.pf), pb.ParticleFilter)

  def test_bayes(self):
    # verify that PF gives appropriate results
    np.set_printoptions(linewidth=120, precision=2, suppress=True)
    for i in range(20):
      self.pf.bayes(np.array([i], dtype=float))
      pdf = self.pf.posterior()
      print "observation, mean:", i, pdf.mean()[0]
      print "particles, mean:", pdf.particles.view().squeeze()
\stopcode
\hairline
\stopsection
\stopchapter

\startchapter[title=Appendix: Project Log]
% \placefigure[place]{Log Book}{\clip[width=150mm,height=180mm,hoffset=5mm,voffset=30mm]{\externalfigure[logbook.pdf][page=1,xscale=800,yscale=800,width=\textwidth,height=\textheight]}}
\vfill
\startplacefigure[location=place,title={Log Book (page 1)}]
\externalfigure[logbook.pdf][page=1]
\stopplacefigure
\vfill
\page[yes]
\ 
\vfill
\startplacefigure[location=place,title={Log Book (page 2)}]
\externalfigure[logbook.pdf][page=2]
\stopplacefigure
\vfill
\page[yes]
\ 
\vfill
\startplacefigure[location=place,title={Log Book (page 3)}]
\externalfigure[logbook.pdf][page=3]
\stopplacefigure
\vfill
\stopchapter

\startchapter[title=Appendix: Project Risk Assessment Form]
\vfill
\startplacefigure[location=place,title={Risk Assessment}]
\externalfigure[assessment.pdf][page=1]
\stopplacefigure
\vfill
\stopchapter

\startchapter[title={Appendix: Project Ethical Form},reference=chapter:ethics]
\vfill
\startplacefigure[location=place,title={Ethical and Risk Assessment (page 1)}]
\externalfigure[ethics.pdf][page=1]
\stopplacefigure
\vfill
\page[yes]
\vfill
\startplacefigure[location=place,title={Ethical and Risk Assessment (page 2)}]
\externalfigure[ethics.pdf][page=2]
\stopplacefigure
\vfill
\page[yes]
\vfill
\startplacefigure[location=place,title={Ethical and Risk Assessment (page 3)}]
\externalfigure[ethics.pdf][page=3]
\stopplacefigure
\vfill
%\page[yes]
%\vfill
%\placefigure[place]{Ethical and Risk Assessment (page 4)}{\externalfigure[ethics.pdf][page=4]}
%\vfill
\stopchapter
\stopcomponent
